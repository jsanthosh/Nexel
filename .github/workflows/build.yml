name: Build Nexel

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ─────────────────────────────────────────────
  # macOS  —  Build .dmg (Universal: Apple Silicon + Intel)
  # ─────────────────────────────────────────────
  build-macos:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt6 via Homebrew
        run: |
          brew install qt@6

      - name: Configure CMake
        run: |
          export Qt6_DIR=$(brew --prefix qt@6)/lib/cmake/Qt6
          cd native
          mkdir -p build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_PREFIX_PATH="$Qt6_DIR" \
                -DCMAKE_INSTALL_PREFIX=../install \
                ..

      - name: Build
        run: |
          cd native/build
          cmake --build . --config Release -j$(sysctl -n hw.ncpu)

      - name: Install
        run: |
          cd native/build
          cmake --install . --config Release

      - name: Verify binary architecture
        run: |
          file native/install/Nexel.app/Contents/MacOS/Nexel
          otool -L native/install/Nexel.app/Contents/MacOS/Nexel | head -20

      - name: Deploy Qt frameworks and sign
        run: |
          export PATH="$(brew --prefix qt@6)/bin:$PATH"
          cd native/install
          macdeployqt Nexel.app -verbose=2 -always-overwrite
          # Ad-hoc code sign all frameworks and the app
          codesign --force --deep --sign - Nexel.app

          # Create DMG with Applications shortcut
          mkdir -p dmg_staging
          cp -R Nexel.app dmg_staging/
          ln -s /Applications dmg_staging/Applications
          hdiutil create -volname "Nexel" -srcfolder dmg_staging -ov -format UDZO Nexel.dmg
          rm -rf dmg_staging

      - name: Rename DMG
        run: |
          mv native/install/Nexel.dmg Nexel-macOS.dmg

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: Nexel-macOS
          path: Nexel-macOS.dmg

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: Nexel-macOS.dmg

  # ─────────────────────────────────────────────
  # Windows  —  Build .exe installer
  # ─────────────────────────────────────────────
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.3'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          modules: 'qtnetworkauth'
          cache: true

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Configure CMake
        shell: cmd
        run: |
          cd native
          mkdir build
          cd build
          cmake -G "NMake Makefiles" ^
                -DCMAKE_BUILD_TYPE=Release ^
                -DCMAKE_PREFIX_PATH="%Qt6_DIR%" ^
                -DCMAKE_INSTALL_PREFIX=..\install ^
                ..

      - name: Build
        shell: cmd
        run: |
          cd native\build
          cmake --build . --config Release

      - name: Install
        shell: cmd
        run: |
          cd native\build
          cmake --install . --config Release

      - name: Deploy Qt DLLs
        shell: cmd
        run: |
          cd native\install\bin
          windeployqt --release --no-translations --no-opengl-sw Nexel.exe

      - name: Create portable ZIP
        shell: pwsh
        run: |
          Compress-Archive -Path native\install\bin\* -DestinationPath Nexel-Windows-x64.zip

      - name: Upload Windows ZIP
        uses: actions/upload-artifact@v4
        with:
          name: Nexel-Windows-x64-portable
          path: Nexel-Windows-x64.zip

      - name: Install NSIS
        shell: pwsh
        run: |
          choco install nsis -y --no-progress

      - name: Create NSIS installer
        shell: pwsh
        run: |
          $nsiContent = @'
          !include "MUI2.nsh"

          Name "Nexel"
          OutFile "Nexel-Windows-x64-Setup.exe"
          InstallDir "$PROGRAMFILES64\Nexel"
          RequestExecutionLevel admin

          !insertmacro MUI_PAGE_DIRECTORY
          !insertmacro MUI_PAGE_INSTFILES
          !insertmacro MUI_LANGUAGE "English"

          Section "Install"
            SetOutPath "$INSTDIR"
            File /r ".\*.*"

            CreateDirectory "$SMPROGRAMS\Nexel"
            CreateShortcut "$SMPROGRAMS\Nexel\Nexel.lnk" "$INSTDIR\Nexel.exe"
            CreateShortcut "$DESKTOP\Nexel.lnk" "$INSTDIR\Nexel.exe"

            WriteUninstaller "$INSTDIR\Uninstall.exe"

            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Nexel" "DisplayName" "Nexel"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Nexel" "UninstallString" "$INSTDIR\Uninstall.exe"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Nexel" "DisplayVersion" "1.0.0"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Nexel" "Publisher" "Nexel"
          SectionEnd

          Section "Uninstall"
            RMDir /r "$INSTDIR"
            RMDir /r "$SMPROGRAMS\Nexel"
            Delete "$DESKTOP\Nexel.lnk"
            DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Nexel"
          SectionEnd
          '@
          $nsiContent | Out-File -FilePath native\install\bin\installer.nsi -Encoding ASCII

          $env:PATH += ";C:\Program Files (x86)\NSIS"
          Push-Location native\install\bin
          & makensis installer.nsi
          Pop-Location
          Move-Item native\install\bin\Nexel-Windows-x64-Setup.exe .

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: Nexel-Windows-x64-Setup
          path: Nexel-Windows-x64-Setup.exe

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            Nexel-Windows-x64.zip
            Nexel-Windows-x64-Setup.exe
