name: Build Nexel

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ─────────────────────────────────────────────
  # macOS  —  Build .dmg (Apple Silicon)
  # ─────────────────────────────────────────────
  build-macos:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.3'
          host: 'mac'
          target: 'desktop'
          arch: 'clang_64'
          modules: 'qtnetworkauth'
          cache: true

      - name: Configure CMake
        run: |
          cd native
          mkdir -p build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_OSX_ARCHITECTURES=arm64 \
                -DCMAKE_PREFIX_PATH="$Qt6_DIR" \
                -DCMAKE_INSTALL_PREFIX=../install \
                ..

      - name: Build
        run: |
          cd native/build
          cmake --build . --config Release -j$(sysctl -n hw.ncpu)

      - name: Install
        run: |
          cd native/build
          cmake --install . --config Release

      - name: Deploy Qt frameworks
        run: |
          cd native/install
          macdeployqt Nexel.app -dmg

      - name: Rename DMG
        run: |
          mv native/install/Nexel.dmg Nexel-macOS-arm64.dmg

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: Nexel-macOS-arm64
          path: Nexel-macOS-arm64.dmg

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: Nexel-macOS-arm64.dmg

  # ─────────────────────────────────────────────
  # Windows  —  Build .exe installer
  # ─────────────────────────────────────────────
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.3'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          modules: 'qtnetworkauth qtdeclarative'
          cache: true

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Configure CMake
        shell: cmd
        run: |
          cd native
          mkdir build
          cd build
          cmake -G "NMake Makefiles" ^
                -DCMAKE_BUILD_TYPE=Release ^
                -DCMAKE_PREFIX_PATH="%Qt6_DIR%" ^
                -DCMAKE_INSTALL_PREFIX=..\install ^
                ..

      - name: Build
        shell: cmd
        run: |
          cd native\build
          cmake --build . --config Release

      - name: Install
        shell: cmd
        run: |
          cd native\build
          cmake --install . --config Release

      - name: Deploy Qt DLLs
        shell: cmd
        run: |
          cd native\install\bin
          windeployqt --release --no-translations --no-opengl-sw Nexel.exe

      - name: Create portable ZIP
        shell: pwsh
        run: |
          Compress-Archive -Path native\install\bin\* -DestinationPath Nexel-Windows-x64.zip

      - name: Create NSIS installer script
        shell: pwsh
        run: |
          $nsiContent = @'
          !include "MUI2.nsh"

          Name "Nexel"
          OutFile "..\..\..\Nexel-Windows-x64-Setup.exe"
          InstallDir "$PROGRAMFILES64\Nexel"
          RequestExecutionLevel admin

          !insertmacro MUI_PAGE_DIRECTORY
          !insertmacro MUI_PAGE_INSTFILES
          !insertmacro MUI_LANGUAGE "English"

          Section "Install"
            SetOutPath "$INSTDIR"
            File /r ".\*.*"

            CreateDirectory "$SMPROGRAMS\Nexel"
            CreateShortcut "$SMPROGRAMS\Nexel\Nexel.lnk" "$INSTDIR\Nexel.exe"
            CreateShortcut "$DESKTOP\Nexel.lnk" "$INSTDIR\Nexel.exe"

            WriteUninstaller "$INSTDIR\Uninstall.exe"

            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Nexel" "DisplayName" "Nexel"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Nexel" "UninstallString" "$INSTDIR\Uninstall.exe"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Nexel" "DisplayVersion" "1.0.0"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Nexel" "Publisher" "Nexel"
          SectionEnd

          Section "Uninstall"
            RMDir /r "$INSTDIR"
            RMDir /r "$SMPROGRAMS\Nexel"
            Delete "$DESKTOP\Nexel.lnk"
            DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\Nexel"
          SectionEnd
          '@
          $nsiContent | Out-File -FilePath native\install\bin\installer.nsi -Encoding ASCII

      - name: Build NSIS installer
        shell: cmd
        run: |
          choco install nsis -y
          cd native\install\bin
          makensis installer.nsi

      - name: Upload Windows ZIP
        uses: actions/upload-artifact@v4
        with:
          name: Nexel-Windows-x64-portable
          path: Nexel-Windows-x64.zip

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: Nexel-Windows-x64-Setup
          path: Nexel-Windows-x64-Setup.exe

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            Nexel-Windows-x64.zip
            Nexel-Windows-x64-Setup.exe
